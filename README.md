# Infra-Iam-PKI: Certified Infrastructure & Identity

**Version:** 2.0.0
**Maintainer:** DevOps Team

## 1. Project Overview

This repository hosts the **Infrastructure-as-Code (IaC)** for the organization's internal Public Key Infrastructure and Identity Management.

- **Infra-PKI**: Internal Certificate Authority (Step-CA) backed by PostgreSQL.
- **Infra-IAM**: Single Sign-On (Keycloak) secured by the PKI and integrated with Active Directory.
- **Automation Scripts**: A robust toolkit for automated host enrollment, internal trust management, and certificate renewal.

---

## 2. Architecture

```
[Remote Clients] <---> [Caddy Reverse Proxy] <---> [Services]
                                    ^
                                    |
          +-------------------------+-------------------------+
          |                                                   |
    [Infra-PKI]                                         [Infra-IAM]
    (Step-CA + Postgres)                                (Keycloak + Postgres)
          ^                                                   ^
          |                                                   |
    (Root Authority)                                  (Identity Provider)
```

---

## 3. Directory Structure

```plaintext
Infra-Iam-PKI/
├── infra-pki/                  # PKI Service
│   ├── docker-compose.yml
│   └── doc/                    # PKI Documentation
│
├── infra-iam/                  # IAM Service
│   ├── docker-compose.yml
│   └── doc/                    # IAM Documentation
│
└── scripts/                    # Automation Toolkit
    ├── infra-pki/              # Server-side Admin Scripts (generate_token, etc)
    ├── infra-iam/              # IAM Configuration Scripts
    └── common/                 # Portable Client Scripts (join_pki.sh)
```

---

## 4. Quick Start Guide

### 4.1 Deploy Infrastructure

1. **Deploy PKI**:
    See [Infra-PKI Deployment](doc/infra-pki/DEPLOY.md).

    ```bash
    cd infra-pki && docker compose up -d
    ```

2. **Deploy IAM**:
    See [Infra-IAM Deployment](doc/infra-iam/DEPLOY.md).
    *Requires PKI to be running.*

    ```bash
    cd infra-iam && docker compose up -d
    ```

### 4.2 Establish Trust (Local Admin)

To manage the infrastructure, your machine must trust the internal Root CA.

```bash
cd scripts/infra-pki
sudo ./manage_host_trust.sh
# Select Option 1
```

---

## 5. Usage Examples

### Scenario A: Enrolling a New SSH Host (Automated)

You want to onboard a new database server (`db-01`) so you can SSH into it using certificates.

**1. On Infra-PKI Server (Admin):**
Generate a one-time enrollment configuration.

```bash
./scripts/infra-pki/generate_token.sh
# Input: db-01
# Output: db-01_join_pki.env
```

**2. On Remote Host (db-01):**
Copy `join_pki.sh` and the `.env` file, then run it.

```bash
# (Copy files via SCP...)
sudo ./join_pki.sh ssh-host
```

*Result: `db-01` now trusts the CA, has a valid SSH Host Certificate, and will auto-renew it weekly.*

### Scenario B: Configuring Infra-IAM Trust

You re-deployed the PKI and need `infra-iam` to trust the new Root CA.

**1. Generate Token/Config on PKI:**

```bash
./scripts/infra-pki/generate_token.sh
# Input: infra-iam
```

**2. Apply on IAM Host:**

```bash
./scripts/infra-iam/configure_iam_pki.sh /path/to/infra-iam_join_pki.env
# Updates infra-iam/.env automatically
```

### Scenario C: Manual Certificate Request

You have a web service and just need a simple TLS certificate.

```bash
./scripts/infra-pki/get_certificate.sh my-service.example.com
```

---

## 6. Documentation Index

- **Infra-PKI**:
  - [Overview](doc/infra-pki/OVERVIEW.md)
  - [Deployment](doc/infra-pki/DEPLOY.md)
  - [Configuration](doc/infra-pki/CONFIGURATION.md)
  - [Troubleshooting](doc/infra-pki/TROUBLESHOOTING.md)

- **Infra-IAM**:
  - [Overview](doc/infra-iam/OVERVIEW.md)
  - [Deployment](doc/infra-iam/DEPLOY.md)
  - [Configuration](doc/infra-iam/CONFIGURATION.md)
  - [Troubleshooting](doc/infra-iam/TROUBLESHOOTING.md)

---
*Generated by Antigravity Assistant*
